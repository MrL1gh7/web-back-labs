{% extends "base.html" %}

{% block script %}
<style>

    /* Контейнер */
    h1 {
        font-size: 32px;
        margin-bottom: 20px;
        color: #304ffe;
        border-bottom: 3px solid #304ffe;
        padding-bottom: 10px;
    }

    .btn-refresh {
        background: #304ffe;
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: 0.2s;
        margin-bottom: 15px;
    }
    .btn-refresh:hover {
        background: #1a32c4;
    }


    /* СПИСОК ОФИСОВ */
    .office-list {
        list-style: none;
        padding: 0;
        margin: 25px 0;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }

    .office-item {
        background: #ffffff;
        border-radius: 12px;
        padding: 18px;
        display: flex;
        justify-content: space-between;
        align-items: center;

        border: 1px solid #dfe3e8;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        transition: 0.2s;
    }
    .office-item:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.1);
    }

    /* БЛОК ИНФОРМАЦИИ */
    .office-info {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .office-number {
        font-size: 20px;
        font-weight: bold;
        color: #212121;
    }

    .office-status {
        font-size: 14px;
        color: #555;
    }

    .status-free {
        color: #00c853;
        font-weight: bold;
    }
    .status-occupied {
        color: #d50000;
        font-weight: bold;
    }

    .office-price {
        font-size: 16px;
        font-weight: bold;
        color: #304ffe;
        margin-top: 4px;
    }

    /* КНОПКИ */
    .action-buttons {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .btn {
        padding: 9px 14px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: white;
        transition: 0.2s;
    }

    .btn-book {
        background: #00c853;
    }
    .btn-book:hover {
        background: #009624;
    }

    .btn-cancel {
        background: #d50000;
    }
    .btn-cancel:hover {
        background: #9b0000;
    }

    .occupied-info {
        font-size: 14px;
        color: #999;
        font-style: italic;
    }

    .total-cost {
        margin-top: 30px;
        background: #f0f7ff;
        padding: 20px;
        border-left: 6px solid #304ffe;
        border-radius: 8px;
        text-align: left;
        box-shadow: 0 3px 10px rgba(48, 79, 254, 0.15);
    }

    .total-cost h3 {
        margin: 0 0 10px 0;
        font-size: 20px;
        color: #1a237e;
    }

    .total-cost strong {
        font-size: 26px;
        color: #0d47a1;
    }

</style>


<script>
function getOfficeList() {
    const url = "/lab6/json-rpc-api/";
    const json = {
        "jsonrpc": "2.0",
        "method": "info",
        "id": Math.round(Math.random()*1000)
    };

    fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(json)
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            alert("Ошибка: " + data.error.message);
            return;
        }

        const list = data.result;
        const ul = document.getElementById("office-list");
        ul.innerHTML = "";

        let total = 0;
        const login = "{{ session.get('login', '') }}";

        for (let office of list) {
            const li = document.createElement("li");
            li.className = "office-item";

            const info = document.createElement("div");
            info.className = "office-info";

            info.innerHTML = `
                <div class="office-number">Офис №${office.number}</div>
                <div class="office-status">
                    Статус: <span class="${office.tenant ? 'status-occupied' : 'status-free'}">
                    ${office.tenant ? "Занят ("+office.tenant+")" : "Свободен"}</span>
                </div>
                <div class="office-price">${office.price} руб./мес</div>
            `;

            li.appendChild(info);

            const buttons = document.createElement("div");
            buttons.className = "action-buttons";

            if (!office.tenant) {
                const btn = document.createElement("button");
                btn.className = "btn btn-book";
                btn.innerText = "Зарезервировать";
                btn.onclick = () => booking(office.number);
                buttons.appendChild(btn);
            } else if (office.tenant === login) {
                total += office.price;

                const btn = document.createElement("button");
                btn.className = "btn btn-cancel";
                btn.innerText = "Освободить";
                btn.onclick = () => cancelBooking(office.number);
                buttons.appendChild(btn);
            } else {
                const div = document.createElement("div");
                div.innerText = "Занят другим";
                div.style.color = "#777";
                buttons.appendChild(div);
            }

            li.appendChild(buttons);
            ul.appendChild(li);
        }

        updateTotalCost(total);
    })
    .catch(err => alert("Ошибка запроса"));
}

function booking(num) {
    const url = "/lab6/json-rpc-api/";
    const json = {
        "jsonrpc": "2.0",
        "method": "booking",
        "params": num,
        "id": Math.round(Math.random()*1000)
    };

    fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(json)
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            switch(data.error.code) {
                case 1: alert("Вы не авторизованы"); break;
                case 2: alert("Офис уже занят"); break;
                default: alert("Ошибка");
            }
            return;
        }
        getOfficeList();
    });
}

function cancelBooking(num) {
    const url = "/lab6/json-rpc-api/";
    const json = {
        "jsonrpc": "2.0",
        "method": "cancelation",
        "params": num,
        "id": Math.round(Math.random()*1000)
    };

    fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(json)
    })
    .then(r => r.json())
    .then(data => {
        if (data.error) {
            switch(data.error.code) {
                case 1: alert("Не авторизованы"); break;
                case 3: alert("Офис и так свободен"); break;
                case 4: alert("Это не ваш офис"); break;
                case 5: alert("Офис не найден"); break;
            }
            return;
        }
        getOfficeList();
    });
}

function updateTotalCost(total) {
    const div = document.getElementById("total-cost");
    if (total > 0) {
        div.innerHTML = `
            <div class="total-cost">
                <h3>Общая стоимость аренды</h3>
                <strong>${total} руб./мес</strong>
            </div>
        `;
    } else {
        div.innerHTML = `
            <div class="total-cost" style="background:#f2f2f2; border-left-color:#aaa;">
                <h3>У вас нет арендованных офисов</h3>
            </div>
        `;
    }
}

document.addEventListener("DOMContentLoaded", getOfficeList);
</script>
{% endblock %}

{% block lab %}
Лабораторная работа 6
{% endblock %}

{% block main %}
<h1>Аренда офисов</h1>

<button onclick="getOfficeList()" class="btn btn-refresh">Обновить список</button>

{% if session.get('login') %}
    <p>Вы вошли как: <b>{{ session.get('login') }}</b></p>
{% else %}
    <p style="color:red;">Для аренды необходимо авторизоваться</p>
{% endif %}

<ul id="office-list" class="office-list"></ul>

<div id="total-cost"></div>
{% endblock %}
